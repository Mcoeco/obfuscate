<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON UI Obfuscator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
    textarea { width: 100%; height: 200px; margin-bottom: 10px; font-family: monospace; }
    input, select { width: 100%; padding: 5px; margin-bottom: 10px; font-size: 14px; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    pre { background: #fff; padding: 10px; border-radius: 5px; overflow-x: auto; }
    .prefix-options { margin-bottom: 10px; }
    .prefix-options label { margin-right: 15px; }
  </style>
</head>
<body>
  <h1>JSON UI Obfuscator</h1>

  <label>Input JSON:</label>
  <textarea id="inputJSON">{ "namespace": "server_form", "hallo": { "type": "panel", "size": [32, 32] }, "hello@server_form.hallo": {}, "long_form": {}, "hellooo@hello": {}, "idk@server_form.button": {}, "test": { "type": "stack_panel", "factory": { "name": "buttons", "button": "server_form.dynamic_button", "modal": "@server_form.idk" } } }</textarea>

  <label>Prefix (optional):</label>
  <input type="text" id="prefix" placeholder="THIS_CODE_IS_CREATED_BY_MINEBIT_STORE._DO_NOT_SELL,_TRADE_OR_MODIFY_IT_WITHOUT_PERMISSION">

  <div class="prefix-options">
    <label><input type="checkbox" id="useRandomInserts" checked> เพิ่มตัวเลขสุ่มแทรกเล็กน้อย (ทำให้ค้นหายาก แต่ยังอ่านได้)</label>
  </div>

  <label>Blacklist (comma separated):</label>
  <input type="text" id="blacklist" placeholder="long_form">

  <label>History (prefix+blacklist):</label>
  <select id="history" onchange="loadHistory()">
    <option value="">-- เลือกจากประวัติ --</option>
  </select>

  <button onclick="obfuscateJSON()">Obfuscate JSON</button>

  <h2>Output:</h2>
  <pre id="output"></pre>

  <script>
    // ==== Enhanced Prefix Generator ====
    function obfuscatePrefix(originalPrefix) {
      const useRandomInserts = document.getElementById('useRandomInserts').checked;
      
      let result = originalPrefix;
      
      // แค่เพิ่มตัวเลขสุ่มแทรกเล็กน้อย เพื่อไม่ให้ค้นหาเจอง่าย
      if (useRandomInserts && result.length > 10) {
        const insertNumbers = '0123456789';
        const words = result.split(/[._\-]/); // แยกตามตัวคั่น
        
        // แทรกตัวเลขสุ่ม 1-2 ตัวในแต่ละคำ (ไม่ใช่ทุกคำ)
        for (let i = 0; i < words.length; i++) {
          if (words[i].length > 4 && Math.random() > 0.6) { // แทรกแค่บางคำ
            const pos = Math.floor(words[i].length / 2); // แทรกกึ่งกลางคำ
            const randomNum = insertNumbers[Math.floor(Math.random() * insertNumbers.length)];
            words[i] = words[i].slice(0, pos) + randomNum + words[i].slice(pos);
          }
        }
        
        result = words.join('_'); // เชื่อมคืนด้วย _
      }
      
      return result;
    }

    // ==== Random name generator with obfuscated prefix ====
    function randomName(prefix = 'TEXT', len = 20) {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let randomSuffix = '';
      for (let i = 0; i < len; i++) {
        randomSuffix += chars[Math.floor(Math.random() * chars.length)];
      }
      
      // ใช้ prefix ที่ถูก obfuscate แล้ว
      const obfuscatedPrefix = obfuscatePrefix(prefix);
      return obfuscatedPrefix + randomSuffix;
    }

    // ==== Obfuscator (unchanged) ====
    function tools_4no(json, blacklist = [], prefix = 'TEXT') {
      const ns = json.namespace;
      if (!ns) throw new Error('No namespace found');

      const defined = new Set();
      const renameMap = {};

      for (const key in json) {
        if (key === 'namespace' || blacklist.includes(key)) continue;
        const elementName = key.split('@')[0];
        defined.add(elementName);
      }

      for (const key in json) {
        if (key === 'namespace') continue;
        if (key.includes('@') && !key.includes(ns + '.')) continue;

        const elementName = key.split('@')[0];
        if (!renameMap[elementName]) renameMap[elementName] = randomName(prefix);
      }

      let text = JSON.stringify(json);

      for (const [oldName, newName] of Object.entries(renameMap)) {
        if (!defined.has(oldName)) continue;

        const reKey = new RegExp(`"${oldName}(@${ns}\\.[^"]+)?"`, 'g');
        text = text.replace(reKey, (m) => m.replace(oldName, newName));

        const reNs = new RegExp(`@${ns}\\.${oldName}\\b`, 'g');
        text = text.replace(reNs, `@${ns}.${newName}`);

        const reNs2 = new RegExp(`"${ns}\\.${oldName}"`, 'g');
        text = text.replace(reNs2, `"${ns}.${newName}"`);

        const reLocal = new RegExp(`@${oldName}\\b`, 'g');
        text = text.replace(reLocal, `@${newName}`);
      }

      return JSON.parse(text);
    }

    // ==== LocalStorage history ====
    const HISTORY_KEY = 'jsonObfuscatorHistory';

    function saveHistory(prefix, blacklist) {
      const hist = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      const entry = { prefix, blacklist };
      if (!hist.some(h => h.prefix === prefix && h.blacklist === blacklist)) {
        hist.unshift(entry);
        if (hist.length > 10) hist.pop();
        localStorage.setItem(HISTORY_KEY, JSON.stringify(hist));
        loadHistoryOptions();
      }
    }

    function loadHistoryOptions() {
      const hist = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      const sel = document.getElementById('history');
      sel.innerHTML = '<option value="">-- เลือกจากประวัติ --</option>';
      hist.forEach((h,i) => {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Prefix: ${h.prefix || '(default)'} | Blacklist: ${h.blacklist}`;
        sel.appendChild(option);
      });
    }

    function loadHistory() {
      const sel = document.getElementById('history');
      const idx = sel.value;
      if (idx === '') return;
      const hist = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      const entry = hist[idx];
      if (entry) {
        document.getElementById('prefix').value = entry.prefix;
        document.getElementById('blacklist').value = entry.blacklist;
      }
    }

    // ==== Obfuscate button ====
    function obfuscateJSON() {
      const inputText = document.getElementById('inputJSON').value;
      const prefix = document.getElementById('prefix').value || 'TEXT';
      const blacklistText = document.getElementById('blacklist').value;
      const blacklist = blacklistText.split(',').map(s => s.trim()).filter(Boolean);

      try {
        const inputJSON = JSON.parse(inputText);
        const output = tools_4no(inputJSON, blacklist, prefix);
        document.getElementById('output').textContent = JSON.stringify(output, null, 2);
        saveHistory(prefix, blacklistText);
      } catch (e) {
        document.getElementById('output').textContent = 'Error: ' + e.message;
      }
    }

    // โหลด history ตอนเริ่ม
    loadHistoryOptions();
  </script>
</body>
</html>
